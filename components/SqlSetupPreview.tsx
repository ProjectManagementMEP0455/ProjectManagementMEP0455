
import React, { useState } from 'react';

const fullSqlScript = `
-- MEP-DASH: UNIVERSAL RESET & SETUP SCRIPT
-- This script safely cleans up previous attempts and sets up the
-- entire database from scratch. It is safe to run multiple times.
--
-- INSTRUCTIONS:
-- 1. Create the 3 demo users in the Auth section:
--    - director@mep-dash.com
--    - manager@mep-dash.com
--    - engineer@mep-dash.com
-- 2. Run this entire script once in the Supabase SQL Editor.
----------------------------------------------------------------

-- PART 0: CLEANUP (Drop existing objects if they exist)
DROP TABLE IF EXISTS public.milestones CASCADE;
DROP TABLE IF EXISTS public.tasks CASCADE;
DROP TABLE IF EXISTS public.project_team_members CASCADE;
DROP TABLE IF EXISTS public.projects CASCADE;
DROP TABLE IF EXISTS public.profiles CASCADE;
DROP TYPE IF EXISTS public.task_status;
DROP TYPE IF EXISTS public.project_status;
DROP TYPE IF EXISTS public.user_role;

-- PART 1: CREATE TABLES & CUSTOM TYPES
CREATE TYPE public.user_role AS ENUM ('Project Director', 'Project Manager', 'Assistant Project Manager', 'Engineer / Supervisor', 'Site Engineer / Technician');
CREATE TYPE public.project_status AS ENUM ('Active', 'Planning', 'Completed', 'On Hold');
CREATE TYPE public.task_status AS ENUM ('To Do', 'In Progress', 'Done');

CREATE TABLE public.profiles (
    id uuid NOT NULL PRIMARY KEY REFERENCES auth.users ON DELETE CASCADE,
    full_name text,
    avatar_url text,
    role public.user_role
);
CREATE TABLE public.projects (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    name text NOT NULL,
    description text,
    start_date date,
    end_date date,
    budget numeric,
    spent numeric DEFAULT 0,
    status public.project_status DEFAULT 'Planning'::public.project_status,
    created_by uuid REFERENCES public.profiles ON DELETE SET NULL
);
CREATE TABLE public.project_team_members (
    project_id bigint NOT NULL REFERENCES public.projects ON DELETE CASCADE,
    user_id uuid NOT NULL REFERENCES public.profiles ON DELETE CASCADE,
    PRIMARY KEY (project_id, user_id)
);
CREATE TABLE public.tasks (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    name text NOT NULL,
    description text,
    status public.task_status DEFAULT 'To Do'::public.task_status,
    due_date date,
    assignee_id uuid REFERENCES public.profiles ON DELETE SET NULL,
    project_id bigint NOT NULL REFERENCES public.projects ON DELETE CASCADE,
    percent_complete integer DEFAULT 0 CHECK (percent_complete >= 0 AND percent_complete <= 100)
);
CREATE TABLE public.milestones (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    name text NOT NULL,
    due_date date NOT NULL,
    project_id bigint NOT NULL REFERENCES public.projects ON DELETE CASCADE,
    completed boolean DEFAULT false NOT NULL
);

-- PART 2: ENABLE ROW LEVEL SECURITY (RLS) & DEFINE POLICIES
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.projects ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.project_team_members ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.tasks ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.milestones ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Public profiles are viewable by everyone." ON public.profiles FOR SELECT USING (true);
CREATE POLICY "Users can insert their own profile." ON public.profiles FOR INSERT WITH CHECK (auth.uid() = id);
CREATE POLICY "Users can update their own profile." ON public.profiles FOR UPDATE USING (auth.uid() = id);
CREATE POLICY "Users can view projects they are a member of." ON public.projects FOR SELECT USING (EXISTS (SELECT 1 FROM public.project_team_members WHERE project_team_members.project_id = projects.id AND project_team_members.user_id = auth.uid()));
CREATE POLICY "Directors/Managers can create projects." ON public.projects FOR INSERT WITH CHECK (((SELECT role FROM public.profiles WHERE id = auth.uid()) IN ('Project Director'::public.user_role, 'Project Manager'::public.user_role)));
CREATE POLICY "Directors/Managers can update projects." ON public.projects FOR UPDATE USING (((SELECT role FROM public.profiles WHERE id = auth.uid()) IN ('Project Director'::public.user_role, 'Project Manager'::public.user_role)) AND EXISTS (SELECT 1 FROM public.project_team_members WHERE project_team_members.project_id = projects.id AND project_team_members.user_id = auth.uid()));
CREATE POLICY "Team members can view who is on their project." ON public.project_team_members FOR SELECT USING (EXISTS (SELECT 1 FROM public.project_team_members ptm WHERE ptm.project_id = project_team_members.project_id AND ptm.user_id = auth.uid()));
CREATE POLICY "Directors/Managers can add/remove team members." ON public.project_team_members FOR ALL USING (((SELECT role FROM public.profiles WHERE id = auth.uid()) IN ('Project Director'::public.user_role, 'Project Manager'::public.user_role)) AND EXISTS (SELECT 1 FROM public.project_team_members ptm WHERE ptm.project_id = project_team_members.project_id AND ptm.user_id = auth.uid()));
CREATE POLICY "Team members can view tasks on their projects." ON public.tasks FOR SELECT USING (EXISTS (SELECT 1 FROM public.project_team_members WHERE project_team_members.project_id = tasks.project_id AND project_team_members.user_id = auth.uid()));
CREATE POLICY "Team members can create and update tasks." ON public.tasks FOR ALL USING (EXISTS (SELECT 1 FROM public.project_team_members WHERE project_team_members.project_id = tasks.project_id AND project_team_members.user_id = auth.uid()));
CREATE POLICY "Team members can view milestones." ON public.milestones FOR SELECT USING (EXISTS (SELECT 1 FROM public.project_team_members WHERE project_team_members.project_id = milestones.project_id AND project_team_members.user_id = auth.uid()));
CREATE POLICY "Managers can manage milestones." ON public.milestones FOR ALL USING (((SELECT role FROM public.profiles WHERE id = auth.uid()) IN ('Project Director'::public.user_role, 'Project Manager'::public.user_role, 'Assistant Project Manager'::public.user_role)) AND EXISTS (SELECT 1 FROM public.project_team_members WHERE project_team_members.project_id = milestones.project_id AND project_team_members.user_id = auth.uid()));

-- PART 3: PRE-FLIGHT CHECK & SAMPLE DATA INSERTION
DO $$
BEGIN
  IF NOT EXISTS (SELECT 1 FROM auth.users WHERE email = 'director@mep-dash.com') THEN
    RAISE EXCEPTION 'SETUP FAILED: Demo user "director@mep-dash.com" not found. Please create the three required demo users in the "Authentication" section and run this script again.';
  END IF;
  IF NOT EXISTS (SELECT 1 FROM auth.users WHERE email = 'manager@mep-dash.com') THEN
    RAISE EXCEPTION 'SETUP FAILED: Demo user "manager@mep-dash.com" not found. Please create the three required demo users in the "Authentication" section and run this script again.';
  END IF;
  IF NOT EXISTS (SELECT 1 FROM auth.users WHERE email = 'engineer@mep-dash.com') THEN
    RAISE EXCEPTION 'SETUP FAILED: Demo user "engineer@mep-dash.com" not found. Please create the three required demo users in the "Authentication" section and run this script again.';
  END IF;
END $$;

WITH demo_users AS (
  SELECT id, email FROM auth.users
  WHERE email IN ('director@mep-dash.com', 'manager@mep-dash.com', 'engineer@mep-dash.com')
),
inserted_profiles AS (
  INSERT INTO public.profiles (id, full_name, avatar_url, role)
  SELECT
    u.id,
    CASE
      WHEN u.email = 'director@mep-dash.com' THEN 'Alex Director'
      WHEN u.email = 'manager@mep-dash.com' THEN 'Brianna Manager'
      WHEN u.email = 'engineer@mep-dash.com' THEN 'Charlie Engineer'
    END,
    'https://i.pravatar.cc/150?u=' || u.email,
    CASE
      WHEN u.email = 'director@mep-dash.com' THEN 'Project Director'::public.user_role
      WHEN u.email = 'manager@mep-dash.com' THEN 'Project Manager'::public.user_role
      WHEN u.email = 'engineer@mep-dash.com' THEN 'Site Engineer / Technician'::public.user_role
    END
  FROM demo_users u
  ON CONFLICT (id) DO UPDATE SET
    full_name = EXCLUDED.full_name,
    avatar_url = EXCLUDED.avatar_url,
    role = EXCLUDED.role
),
inserted_projects AS (
  INSERT INTO public.projects (name, description, start_date, end_date, budget, spent, status, created_by)
  VALUES
    ('Corporate HQ HVAC Overhaul', 'Complete overhaul of the HVAC system for the 15-story downtown corporate headquarters.', '2024-05-01', '2024-12-20', 7500000, 2200000, 'Active', (SELECT id FROM demo_users WHERE email = 'director@mep-dash.com')),
    ('Hospital Wing Electrical Upgrade', 'Upgrade of all electrical systems for the new pediatric wing.', '2024-07-15', '2025-03-31', 12000000, 500000, 'Planning', (SELECT id FROM demo_users WHERE email = 'manager@mep-dash.com')),
    ('Retail Center Plumbing & Fire Sprinklers', 'Installation of all new plumbing and fire sprinkler systems for a 50,000 sq ft retail center.', '2023-11-01', '2024-08-30', 4500000, 4100000, 'Active', (SELECT id FROM demo_users WHERE email = 'manager@mep-dash.com')),
    ('Data Center Cooling System', 'Design and build of a high-efficiency redundant cooling system.', '2024-01-10', '2024-06-25', 9800000, 9500000, 'Completed', (SELECT id FROM demo_users WHERE email = 'director@mep-dash.com'))
  RETURNING id, name
),
inserted_team_members AS (
  INSERT INTO public.project_team_members (project_id, user_id)
  VALUES
    ((SELECT id FROM inserted_projects WHERE name = 'Corporate HQ HVAC Overhaul'), (SELECT id FROM demo_users WHERE email = 'director@mep-dash.com')),
    ((SELECT id FROM inserted_projects WHERE name = 'Corporate HQ HVAC Overhaul'), (SELECT id FROM demo_users WHERE email = 'manager@mep-dash.com')),
    ((SELECT id FROM inserted_projects WHERE name = 'Corporate HQ HVAC Overhaul'), (SELECT id FROM demo_users WHERE email = 'engineer@mep-dash.com')),
    ((SELECT id FROM inserted_projects WHERE name = 'Hospital Wing Electrical Upgrade'), (SELECT id FROM demo_users WHERE email = 'manager@mep-dash.com')),
    ((SELECT id FROM inserted_projects WHERE name = 'Hospital Wing Electrical Upgrade'), (SELECT id FROM demo_users WHERE email = 'engineer@mep-dash.com')),
    ((SELECT id FROM inserted_projects WHERE name = 'Retail Center Plumbing & Fire Sprinklers'), (SELECT id FROM demo_users WHERE email = 'manager@mep-dash.com')),
    ((SELECT id FROM inserted_projects WHERE name = 'Retail Center Plumbing & Fire Sprinklers'), (SELECT id FROM demo_users WHERE email = 'engineer@mep-dash.com')),
    ((SELECT id FROM inserted_projects WHERE name = 'Data Center Cooling System'), (SELECT id FROM demo_users WHERE email = 'director@mep-dash.com')),
    ((SELECT id FROM inserted_projects WHERE name = 'Data Center Cooling System'), (SELECT id FROM demo_users WHERE email = 'manager@mep-dash.com'))
),
inserted_tasks AS (
  INSERT INTO public.tasks (name, description, status, due_date, assignee_id, project_id, percent_complete)
  VALUES
    ('Procure new chiller units', 'Submit PO and confirm delivery dates for two 500-ton chiller units.', 'Done', '2024-06-15', (SELECT id FROM demo_users WHERE email = 'manager@mep-dash.com'), (SELECT id FROM inserted_projects WHERE name = 'Corporate HQ HVAC Overhaul'), 100),
    ('Install rooftop chiller #1', 'Crane lift and installation of the first chiller unit on the main roof.', 'In Progress', '2024-09-01', (SELECT id FROM demo_users WHERE email = 'engineer@mep-dash.com'), (SELECT id FROM inserted_projects WHERE name = 'Corporate HQ HVAC Overhaul'), 50),
    ('Install rooftop chiller #2', 'Crane lift and installation of the second chiller unit.', 'To Do', '2024-09-15', (SELECT id FROM demo_users WHERE email = 'engineer@mep-dash.com'), (SELECT id FROM inserted_projects WHERE name = 'Corporate HQ HVAC Overhaul'), 0)
)
INSERT INTO public.milestones (name, due_date, project_id, completed)
VALUES
  ('Equipment Procurement Complete', '2024-07-01', (SELECT id FROM inserted_projects WHERE name = 'Corporate HQ HVAC Overhaul'), true),
  ('Rooftop Installation Complete', '2024-09-30', (SELECT id FROM inserted_projects WHERE name = 'Corporate HQ HVAC Overhaul'), false),
  ('System Commissioning', '2024-12-01', (SELECT id FROM inserted_projects WHERE name = 'Corporate HQ HVAC Overhaul'), false);

SELECT 'SUCCESS: MEP-Dash database has been reset and set up successfully!' as status;
`;

const SqlSetupPreview: React.FC = () => {
    const [copyButtonText, setCopyButtonText] = useState('Copy Script');

    const handleCopy = () => {
        navigator.clipboard.writeText(fullSqlScript.trim());
        setCopyButtonText('Copied!');
        setTimeout(() => setCopyButtonText('Copy Script'), 2000);
    };

    return (
        <div className="mt-8 border-t pt-6">
            <h2 className="text-xl font-bold text-center text-neutral-dark mb-4">Supabase SQL Setup Script</h2>
            <p className="text-center text-neutral-medium mb-4 text-sm">
                For first-time setup, run this entire script in your Supabase project's SQL Editor.
            </p>
            <div className="relative bg-neutral-dark rounded-lg p-4">
                <button
                    onClick={handleCopy}
                    className="absolute top-2 right-2 bg-brand-primary text-white font-semibold py-1 px-3 rounded-md hover:bg-brand-dark transition-colors text-sm"
                >
                    {copyButtonText}
                </button>
                <pre className="text-white text-xs overflow-x-auto max-h-64">
                    <code>{fullSqlScript.trim()}</code>
                </pre>
            </div>
        </div>
    );
};

export default SqlSetupPreview;
